<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Exercice 3 – Position vs Marseille</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
  <style>
    html,body{height:100%;margin:0}
    #map{height:100%}
    .panel{position:fixed;right:12px;top:12px;background:rgba(255,255,255,.92);color:#0b1020;border-radius:10px;padding:8px 12px;font:14px/1.3 system-ui,Segoe UI,Roboto,Helvetica,Arial;box-shadow:0 6px 18px rgba(0,0,0,.15);z-index:500}
    .val{font-weight:700}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="panel">Distance jusqu’à Marseille : <span class="val" id="dmar">—</span></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
  <script>
    const NICE=[43.7009358,7.2683912]
    const MARSEILLE=[43.2965,5.3698]
    const map=L.map("map").setView([43.5,6.3],8)
    const base=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap",maxZoom:19}).addTo(map)
    const mNice=L.marker(NICE).addTo(map).bindPopup("Nice")
    const mMRS=L.marker(MARSEILLE).addTo(map).bindPopup("Marseille")
    const seg=L.polyline([NICE,MARSEILLE],{color:"#ef4444",weight:3}).addTo(map)
    map.fitBounds(seg.getBounds(),{padding:[30,30]})
    let userMarker=null
    let userCircle=null
    function km(a,b){const r=6371;const toRad=x=>x*Math.PI/180;const dlat=toRad(b[0]-a[0]);const dlon=toRad(b[1]-a[1]);const la1=toRad(a[0]);const la2=toRad(b[0]);const h=Math.sin(dlat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dlon/2)**2;return 2*r*Math.asin(Math.sqrt(h))}
    function updateUser(lat,lon,acc){
      const pos=[lat,lon]
      if(!userMarker){userMarker=L.marker(pos).addTo(map)}
      else{userMarker.setLatLng(pos)}
      if(!userCircle){
        userCircle=L.circle(pos,{radius:acc||0,color:"#2563eb",weight:1,fillColor:"#60a5fa",fillOpacity:.2}).addTo(map)
      }else{userCircle.setLatLng(pos).setRadius(acc||0)}
      const d=km(pos,MARSEILLE)
      document.getElementById("dmar").textContent=d.toFixed(2)+" km"
      userMarker.bindPopup("Vous • "+d.toFixed(2)+" km de Marseille")
    }
    if("geolocation" in navigator){
      navigator.geolocation.getCurrentPosition(
        p=>{updateUser(p.coords.latitude,p.coords.longitude,p.coords.accuracy);map.setView([p.coords.latitude,p.coords.longitude],12)},
        _=>{document.getElementById("dmar").textContent="localisation indisponible"}
      )
    }else{
      document.getElementById("dmar").textContent="non supporté"
    }
  </script>
</body>
</html>
